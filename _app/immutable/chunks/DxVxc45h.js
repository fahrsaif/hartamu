const se="modulepreload",ae=function(a,e){return new URL(a,e).href},$={},J=function(e,r,l){let t=Promise.resolve();if(r&&r.length>0){let i=function(n){return Promise.all(n.map(u=>Promise.resolve(u).then(f=>({status:"fulfilled",value:f}),f=>({status:"rejected",reason:f}))))};const s=document.getElementsByTagName("link"),c=document.querySelector("meta[property=csp-nonce]"),d=c?.nonce||c?.getAttribute("nonce");t=i(r.map(n=>{if(n=ae(n,l),n in $)return;$[n]=!0;const u=n.endsWith(".css"),f=u?'[rel="stylesheet"]':"";if(l)for(let b=s.length-1;b>=0;b--){const p=s[b];if(p.href===n&&(!u||p.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${n}"]${f}`))return;const h=document.createElement("link");if(h.rel=u?"stylesheet":se,u||(h.as="script"),h.crossOrigin="",h.href=n,d&&h.setAttribute("nonce",d),document.head.appendChild(h),u)return new Promise((b,p)=>{h.addEventListener("load",b),h.addEventListener("error",()=>p(new Error(`Unable to preload CSS for ${n}`)))})}))}function o(s){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=s,window.dispatchEvent(c),!c.defaultPrevented)throw s}return t.then(s=>{for(const c of s||[])c.status==="rejected"&&o(c.reason);return e().catch(o)})},W="function",S="64e10b34-2bf7-4616-9668-f99de5aa046e";const{isArray:O}=Array;let{SharedArrayBuffer:j,window:ne}=globalThis,{notify:V,wait:Z,waitAsync:C}=Atomics,X=null;C||(C=a=>({value:new Promise(e=>{let r=new Worker("data:application/javascript,onmessage%3D(%7Bdata%3Ab%7D)%3D%3E(Atomics.wait(b%2C0)%2CpostMessage(0))");r.onmessage=e,r.postMessage(a)})}));try{new j(4)}catch{j=ArrayBuffer;const e=new WeakMap;if(ne){const r=new Map,{prototype:{postMessage:l}}=Worker,t=o=>{const s=o.data?.[S];if(!O(s)){o.stopImmediatePropagation();const{id:c,sb:d}=s;r.get(c)(d)}};X=function(o,...s){const c=o?.[S];if(O(c)){const[d,i]=c;e.set(i,d),this.addEventListener("message",t)}return l.call(this,o,...s)},C=o=>({value:new Promise(s=>{r.set(e.get(o),s)}).then(s=>{r.delete(e.get(o)),e.delete(o);for(let c=0;c<s.length;c++)o[c]=s[c];return"ok"})})}else{const r=(l,t)=>({[S]:{id:l,sb:t}});V=l=>{postMessage(r(e.get(l),l))},addEventListener("message",l=>{const t=l.data?.[S];if(O(t)){const[o,s]=t;e.set(s,o)}})}}const{Int32Array:A,Map:B,Uint16Array:Q}=globalThis,{BYTES_PER_ELEMENT:N}=A,{BYTES_PER_ELEMENT:oe}=Q,ce=(a,e,r)=>{for(;Z(a,0,0,e)==="timed-out";)r()},z=new WeakSet,I=new WeakMap,le={value:{then:a=>a()}};let ue=0;const F=(a,{parse:e=JSON.parse,stringify:r=JSON.stringify,transform:l,interrupt:t}=JSON)=>{if(!I.has(a)){const o=X||a.postMessage,s=(f,...h)=>o.call(a,{[S]:h},{transfer:f}),c=typeof t===W?t:t?.handler,d=t?.delay||42,i=new TextDecoder("utf-16"),n=(f,h)=>f?C(h,0):(c?ce(h,d,c):Z(h,0),le);let u=!1;I.set(a,new Proxy(new B,{has:(f,h)=>typeof h=="string"&&!h.startsWith("_"),get:(f,h)=>h==="then"?null:((...b)=>{const p=ue++;let w=new A(new j(N*2)),q=[];z.has(b.at(-1)||q)&&z.delete(q=b.pop()),s(q,p,w,h,l?b.map(l):b);const E=a!==globalThis;let M=0;return u&&E&&(M=setTimeout(console.warn,1e3,`ðŸ’€ðŸ”’ - Possible deadlock if proxy.${h}(...args) is awaited`)),n(E,w).value.then(()=>{clearTimeout(M);const g=w[1];if(!g)return;const v=oe*g;return w=new A(new j(v+v%N)),s([],p,w),n(E,w).value.then(()=>e(i.decode(new Q(w.buffer).slice(0,g))))})}),set(f,h,b){const p=typeof b;if(p!==W)throw new Error(`Unable to assign ${h} as ${p}`);if(!f.size){const w=new B;a.addEventListener("message",async q=>{const E=q.data?.[S];if(O(E)){q.stopImmediatePropagation();const[M,g,...v]=E;let y;if(v.length){const[k,P]=v;if(f.has(k)){u=!0;try{const m=await f.get(k)(...P);if(m!==void 0){const R=r(l?l(m):m);w.set(M,R),g[1]=R.length}}catch(m){y=m}finally{u=!1}}else y=new Error(`Unsupported action: ${k}`);g[0]=1}else{const k=w.get(M);w.delete(M);for(let P=new Q(g.buffer),m=0;m<k.length;m++)P[m]=k.charCodeAt(m)}if(V(g,0),y)throw y}})}return!!f.set(h,b)}}))}return I.get(a)};F.transfer=(...a)=>(z.add(a),a);function U(){let a,e;return{lock:async()=>{for(;a;)await a;a=new Promise(t=>{e=t})},unlock:async()=>{const t=e;a=void 0,e=void 0,t?.()}}}async function ee(a,e){let r;if(a instanceof Blob?r=a.stream():r=a,r instanceof ReadableStream&&e){const t=r.getReader();switch(e){case"callback":return async()=>(await t.read()).value;case"buffer":const o=[];let s=!1;for(;!s;){const n=await t.read();n.value&&o.push(n.value),s=n.done}const c=o.reduce((n,u)=>n+u.length,0),d=new Uint8Array(c);let i=0;return o.forEach(n=>{d.set(n,i),i+=n.length}),d.buffer}}else return r}class L{constructor(e){Object.defineProperty(this,"sqlite3InitModule",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"sqlite3",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"db",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"pointers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"writeCallbacks",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"storageType",{enumerable:!0,configurable:!0,writable:!0,value:"memory"})}async init(e){const{databasePath:r}=e,l=this.getFlags(e);if(!this.sqlite3InitModule){const{default:t}=await J(async()=>{const{default:o}=await import("./CME-M_ml.js");return{default:o}},[],import.meta.url);this.sqlite3InitModule=t}this.sqlite3||(this.sqlite3=await this.sqlite3InitModule()),this.db&&await this.destroy(),this.db=new this.sqlite3.oo1.DB(r,l),this.config=e,this.initWriteHook()}onWrite(e){return this.writeCallbacks.add(e),()=>{this.writeCallbacks.delete(e)}}async exec(e){if(!this.db)throw new Error("Driver not initialized");return this.execOnDb(this.db,e)}async execBatch(e){if(!this.db)throw new Error("Driver not initialized");const r=[];return this.db.transaction(l=>{const t=new Map;try{for(let o of e){let s=t.get(o.sql);if(!s){const i=l.prepare(o.sql);t.set(o.sql,i),s=i}o.params?.length&&s.bind(o.params);let c=[],d=[];for(;s.step();)c=s.getColumnNames([]),d.push(s.get([]));r.push({columns:c,rows:d}),s.reset()}}finally{t.forEach(o=>{o.finalize()})}}),r}async isDatabasePersisted(){return!1}async getDatabaseSizeBytes(){const r=(await this.exec({sql:`SELECT page_count * page_size AS size 
				FROM pragma_page_count(), pragma_page_size()`,method:"get"}))?.rows?.[0];if(typeof r!="number")throw new Error("Failed to query database size");return r}async createFunction(e){if(!this.db)throw new Error("Driver not initialized");switch(e.type){case"callback":case"scalar":this.db.createFunction({name:e.name,xFunc:(r,...l)=>e.func(...l),arity:-1});break;case"aggregate":this.db.createFunction({name:e.name,xStep:(r,...l)=>e.func.step(...l),xFinal:(r,...l)=>e.func.final(...l),arity:-1});break}}async import(e){if(!this.sqlite3||!this.db||!this.config)throw new Error("Driver not initialized");const r=await ee(e,"buffer"),l=this.sqlite3.wasm.allocFromTypedArray(r);this.pointers.push(l);const t=this.sqlite3.capi.sqlite3_deserialize(this.db,"main",l,r.byteLength,r.byteLength,this.config.readOnly?this.sqlite3.capi.SQLITE_DESERIALIZE_READONLY:this.sqlite3.capi.SQLITE_DESERIALIZE_RESIZEABLE);this.db.checkRc(t)}async export(){if(!this.sqlite3||!this.db)throw new Error("Driver not initialized");return{name:"database.sqlite3",data:this.sqlite3.capi.sqlite3_js_db_export(this.db)}}async clear(){}async destroy(){this.closeDb(),this.pointers.forEach(e=>this.sqlite3?.wasm.dealloc(e)),this.pointers=[],this.writeCallbacks.clear()}getFlags(e){const{readOnly:r,verbose:l}=e;return[r===!0?"r":"cw",l===!0?"t":""].join("")}execOnDb(e,r){const l={rows:[],columns:[]},t=e.exec({sql:r.sql,bind:r.params,returnValue:"resultRows",rowMode:"array",columnNames:l.columns});switch(r.method){case"run":break;case"get":l.rows=t[0]??[];break;case"all":default:l.rows=t;break}return l}initWriteHook(){if(!this.config?.reactive)return;if(!this.sqlite3||!this.db)throw new Error("Driver not initialized");const e={[this.sqlite3.capi.SQLITE_INSERT]:"insert",[this.sqlite3.capi.SQLITE_UPDATE]:"update",[this.sqlite3.capi.SQLITE_DELETE]:"delete"};this.sqlite3.capi.sqlite3_update_hook(this.db,(r,l,t,o,s)=>{this.writeCallbacks.forEach(c=>{c({table:o,rowid:s,operation:e[l]})})},0)}closeDb(){this.db&&(this.db.close(),this.db=void 0)}}function fe(a,e,r){let l,t,o,s,c,d,i=0,n=!1,u=!1,f=!0;if(typeof a!="function")throw new TypeError("Expected a function");e=Number(e)||0,typeof r=="object"&&r!==null&&(n=!!r.leading,u="maxWait"in r,o=u?Math.max(Number(r.maxWait)||0,e):0,f="trailing"in r?!!r.trailing:f);function h(y){const k=l,P=t;return l=t=void 0,i=y,s=a.apply(P,k),s}function b(y){return i=y,c=setTimeout(q,e),n?h(y):s}function p(y){const k=y-(d??0),P=y-i,m=e-k;return u?Math.min(m,o-P):m}function w(y){const k=y-(d??0),P=y-i;return d===void 0||k>=e||k<0||u&&P>=o}function q(){const y=Date.now();if(w(y))return E(y);c=setTimeout(q,p(y))}function E(y){return c=void 0,f&&l?h(y):(l=t=void 0,s)}function M(){c!==void 0&&clearTimeout(c),i=0,l=d=t=c=void 0}function g(){return c===void 0?s:E(Date.now())}function v(){const y=Date.now(),k=w(y);if(l=arguments,t=this,d=y,k){if(c===void 0)return b(d);if(u)return c=setTimeout(q,e),h(d)}return c===void 0&&(c=setTimeout(q,e)),s}return v.cancel=M,v.flush=g,v}function T(){return crypto.randomUUID()}function te(a,e){switch(a){case"session":case":sessionStorage:":let r=sessionStorage._sqlocal_session_key;return r||(r=T(),sessionStorage._sqlocal_session_key=r),`session:${r}`;case"local":case":localStorage:":return"local";case":memory:":return`memory:${e}`;default:return`path:${a}`}}class _{constructor(e){Object.defineProperty(this,"driver",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"userFunctions",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"initMutex",{enumerable:!0,configurable:!0,writable:!0,value:U()}),Object.defineProperty(this,"transactionMutex",{enumerable:!0,configurable:!0,writable:!0,value:U()}),Object.defineProperty(this,"transactionKey",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"proxy",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dirtyTables",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"effectsChannel",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reinitChannel",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onmessage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"init",{enumerable:!0,configurable:!0,writable:!0,value:async t=>{if(!(!this.config.databasePath||!this.config.clientKey)){await this.initMutex.lock();try{try{await this.driver.init(this.config)}catch{console.warn(`Persistence failed, so ${this.config.databasePath} will not be saved. For origin private file system persistence, make sure your web server is configured to use the correct HTTP response headers (See https://sqlocal.dev/guide/setup#cross-origin-isolation).`),this.config.databasePath=":memory:",this.driver=new L,await this.driver.init(this.config)}const o=te(this.config.databasePath,this.config.clientKey);this.reinitChannel=new BroadcastChannel(`_sqlocal_reinit_(${o})`),this.reinitChannel.onmessage=s=>{const c=s.data;if(this.config.clientKey!==c.clientKey)switch(c.type){case"reinit":this.init(c.reason);break;case"close":this.driver.destroy();break}},this.config.reactive&&(this.effectsChannel=new BroadcastChannel(`_sqlocal_effects_(${o})`),this.driver.onWrite(async s=>{this.dirtyTables.add(s.table),await this.transactionMutex.lock(),this.emitEffectsDebounced(),await this.transactionMutex.unlock()})),await Promise.all(Array.from(this.userFunctions.values()).map(s=>this.initUserFunction(s))),await this.execInitStatements(),this.emitMessage({type:"event",event:"connect",reason:t})}catch(o){this.emitMessage({type:"error",error:o,queryKey:null}),await this.destroy()}finally{await this.initMutex.unlock()}}}}),Object.defineProperty(this,"postMessage",{enumerable:!0,configurable:!0,writable:!0,value:async(t,o)=>{const s=t instanceof MessageEvent?t.data:t;switch(await this.initMutex.lock(),s.type){case"config":this.editConfig(s);break;case"query":case"batch":case"transaction":this.exec(s);break;case"function":this.createUserFunction(s);break;case"getinfo":this.getDatabaseInfo(s);break;case"import":this.importDb(s);break;case"export":this.exportDb(s);break;case"delete":this.deleteDb(s);break;case"destroy":this.destroy(s);break}await this.initMutex.unlock()}}),Object.defineProperty(this,"emitMessage",{enumerable:!0,configurable:!0,writable:!0,value:(t,o=[])=>{this.onmessage&&this.onmessage(t,o)}}),Object.defineProperty(this,"emitEffects",{enumerable:!0,configurable:!0,writable:!0,value:()=>{!this.effectsChannel||this.dirtyTables.size===0||(this.effectsChannel.postMessage({type:"effects",tables:[...this.dirtyTables]}),this.dirtyTables.clear())}}),Object.defineProperty(this,"emitEffectsDebounced",{enumerable:!0,configurable:!0,writable:!0,value:fe(()=>this.emitEffects(),32,{maxWait:180})}),Object.defineProperty(this,"editConfig",{enumerable:!0,configurable:!0,writable:!0,value:t=>{this.config=t.config,this.init("initial")}}),Object.defineProperty(this,"exec",{enumerable:!0,configurable:!0,writable:!0,value:async t=>{try{const o={type:"data",queryKey:t.queryKey,data:[]};switch(t.type){case"query":const s=this.transactionKey!==null&&this.transactionKey===t.transactionKey;try{s||await this.transactionMutex.lock();const c=await this.driver.exec(t);o.data.push(c)}finally{s||await this.transactionMutex.unlock()}break;case"batch":try{await this.transactionMutex.lock();const c=await this.driver.execBatch(t.statements);o.data.push(...c)}finally{await this.transactionMutex.unlock()}break;case"transaction":if(t.action==="begin"&&(await this.transactionMutex.lock(),this.transactionKey=t.transactionKey,await this.driver.exec({sql:"BEGIN"})),(t.action==="commit"||t.action==="rollback")&&this.transactionKey!==null&&this.transactionKey===t.transactionKey){const c=t.action==="commit"?"COMMIT":"ROLLBACK";await this.driver.exec({sql:c}),this.transactionKey=null,await this.transactionMutex.unlock()}break}this.emitMessage(o)}catch(o){this.emitMessage({type:"error",error:o,queryKey:t.queryKey})}}}),Object.defineProperty(this,"execInitStatements",{enumerable:!0,configurable:!0,writable:!0,value:async()=>{if(this.config.onInitStatements)for(let t of this.config.onInitStatements)await this.driver.exec(t)}}),Object.defineProperty(this,"getDatabaseInfo",{enumerable:!0,configurable:!0,writable:!0,value:async t=>{try{this.emitMessage({type:"info",queryKey:t.queryKey,info:{databasePath:this.config.databasePath,storageType:this.driver.storageType,databaseSizeBytes:await this.driver.getDatabaseSizeBytes(),persisted:await this.driver.isDatabasePersisted()}})}catch(o){this.emitMessage({type:"error",queryKey:t.queryKey,error:o})}}}),Object.defineProperty(this,"createUserFunction",{enumerable:!0,configurable:!0,writable:!0,value:async t=>{const{functionName:o,functionType:s,queryKey:c}=t;let d;if(this.userFunctions.has(o)){this.emitMessage({type:"error",error:new Error(`A user-defined function with the name "${o}" has already been created for this SQLocal instance.`),queryKey:c});return}switch(s){case"callback":d={type:s,name:o,func:(...i)=>{this.emitMessage({type:"callback",name:o,args:i})}};break;case"scalar":d={type:s,name:o,func:this.proxy[`_sqlocal_func_${o}`]};break;case"aggregate":d={type:s,name:o,func:{step:this.proxy[`_sqlocal_func_${o}_step`],final:this.proxy[`_sqlocal_func_${o}_final`]}};break}try{await this.initUserFunction(d),this.emitMessage({type:"success",queryKey:c})}catch(i){this.emitMessage({type:"error",error:i,queryKey:c})}}}),Object.defineProperty(this,"initUserFunction",{enumerable:!0,configurable:!0,writable:!0,value:async t=>{await this.driver.createFunction(t),this.userFunctions.set(t.name,t)}}),Object.defineProperty(this,"importDb",{enumerable:!0,configurable:!0,writable:!0,value:async t=>{const{queryKey:o,database:s}=t;let c=!1;try{await this.driver.import(s),this.driver.storageType==="memory"&&await this.execInitStatements()}catch(d){this.emitMessage({type:"error",error:d,queryKey:o}),c=!0}finally{this.driver.storageType!=="memory"&&await this.init("overwrite")}c||this.emitMessage({type:"success",queryKey:o})}}),Object.defineProperty(this,"exportDb",{enumerable:!0,configurable:!0,writable:!0,value:async t=>{const{queryKey:o}=t;try{const{name:s,data:c}=await this.driver.export();this.emitMessage({type:"buffer",queryKey:o,bufferName:s,buffer:c},[c])}catch(s){this.emitMessage({type:"error",error:s,queryKey:o})}}}),Object.defineProperty(this,"deleteDb",{enumerable:!0,configurable:!0,writable:!0,value:async t=>{const{queryKey:o}=t;let s=!1;try{await this.driver.clear()}catch(c){this.emitMessage({type:"error",error:c,queryKey:o}),s=!0}finally{await this.init("delete")}s||this.emitMessage({type:"success",queryKey:o})}}),Object.defineProperty(this,"destroy",{enumerable:!0,configurable:!0,writable:!0,value:async t=>{await this.driver.exec({sql:"PRAGMA optimize"}),await this.driver.destroy(),this.effectsChannel&&(this.emitEffectsDebounced.flush(),this.effectsChannel.close(),this.effectsChannel=void 0),this.reinitChannel&&(this.reinitChannel.close(),this.reinitChannel=void 0),t&&this.emitMessage({type:"success",queryKey:t.queryKey})}});const l=typeof WorkerGlobalScope<"u"&&globalThis instanceof WorkerGlobalScope?F(globalThis):globalThis;this.proxy=l,this.driver=e}}function D(a,...e){return{sql:a.join("?"),params:e}}function he(a){return!a.some(e=>!Array.isArray(e))}function K(a,e){let r;return he(a)?r=a:r=[a],r.map(l=>{const t={};return e.forEach((o,s)=>{t[o]=l[s]}),t})}function be(a){return typeof a=="object"&&a!==null&&"getSQL"in a&&typeof a.getSQL=="function"}function de(a){return typeof a=="object"&&a!==null&&"sql"in a&&typeof a.sql=="string"&&"params"in a}function H(a){if(typeof a=="function"&&(a=a(D)),be(a))try{if(!("toSQL"in a&&typeof a.toSQL=="function"))throw 1;const l=a.toSQL();if(!de(l))throw 2;const t="all"in a&&typeof a.all=="function"?a.all:void 0;return{...l,exec:t?()=>t():void 0}}catch{throw new Error("The passed statement could not be parsed.")}const e=a.sql;let r=[];return"params"in a?r=a.params:"parameters"in a&&(r=a.parameters),{sql:e,params:r}}function Y(a,e){let r;return typeof a=="string"?r={sql:a,params:e}:r=D(a,...e),r}async function x(a,e,r,l){return!e&&"locks"in navigator?navigator.locks.request(`_sqlocal_mutation_(${r.databasePath})`,{mode:a},l):l()}class G extends L{constructor(e,r){super(r),Object.defineProperty(this,"storageType",{enumerable:!0,configurable:!0,writable:!0,value:e})}async init(e){const r=this.getFlags(e);if(e.readOnly)throw new Error(`SQLite storage type "${this.storageType}" does not support read-only mode.`);if(!this.sqlite3InitModule){const{default:l}=await J(async()=>{const{default:t}=await import("./CME-M_ml.js");return{default:t}},[],import.meta.url);this.sqlite3InitModule=l}this.sqlite3||(this.sqlite3=await this.sqlite3InitModule()),this.db&&await this.destroy(),this.db=new this.sqlite3.oo1.JsStorageDb({filename:this.storageType,flags:r}),this.config=e,this.initWriteHook()}async isDatabasePersisted(){return navigator.storage?.persisted()}async getDatabaseSizeBytes(){if(!this.db)throw new Error("Driver not initialized");return this.db.storageSize()}async import(e){const r=new L;await r.init({}),await r.import(e),await this.clear(),await r.exec({sql:`VACUUM INTO 'file:${this.storageType}?vfs=kvvfs'`}),await r.destroy()}async clear(){if(!this.db)throw new Error("Driver not initialized");this.db.clearStorage()}async destroy(){this.closeDb(),this.writeCallbacks.clear()}}var re,ie;class ye{constructor(e){Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"processor",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isDestroyed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"bypassMutationLock",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"transactionQueryKeyQueue",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"userCallbacks",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"queriesInProgress",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"proxy",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reinitChannel",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"effectsChannel",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"processMessageEvent",{enumerable:!0,configurable:!0,writable:!0,value:i=>{const n=i instanceof MessageEvent?i.data:i,u=this.queriesInProgress;switch(n.type){case"success":case"data":case"buffer":case"info":case"error":if(n.queryKey&&u.has(n.queryKey)){const[h,b]=u.get(n.queryKey);n.type==="error"?b(n.error):h(n),u.delete(n.queryKey)}else if(n.type==="error")throw n.error;break;case"callback":const f=this.userCallbacks.get(n.name);f&&f(...n.args??[]);break;case"event":this.config.onConnect?.(n.reason);break}}}),Object.defineProperty(this,"createQuery",{enumerable:!0,configurable:!0,writable:!0,value:async i=>x("shared",this.bypassMutationLock||i.type==="import"||i.type==="delete",this.config,async()=>{if(this.isDestroyed===!0)throw new Error("This SQLocal client has been destroyed. You will need to initialize a new client in order to make further queries.");const n=T();switch(i.type){case"import":this.processor.postMessage({...i,queryKey:n},[i.database]);break;default:this.processor.postMessage({...i,queryKey:n});break}return new Promise((u,f)=>{this.queriesInProgress.set(n,[u,f])})})}),Object.defineProperty(this,"broadcast",{enumerable:!0,configurable:!0,writable:!0,value:i=>{this.reinitChannel.postMessage(i)}}),Object.defineProperty(this,"exec",{enumerable:!0,configurable:!0,writable:!0,value:async(i,n,u="all",f)=>{const h=await this.createQuery({type:"query",transactionKey:f,sql:i,params:n,method:u}),b={rows:[],columns:[]};return h.type==="data"&&(b.rows=h.data[0]?.rows??[],b.columns=h.data[0]?.columns??[]),b}}),Object.defineProperty(this,"execBatch",{enumerable:!0,configurable:!0,writable:!0,value:async i=>{const n=await this.createQuery({type:"batch",statements:i}),u=new Array(i.length).fill({rows:[],columns:[]});return n.type==="data"&&n.data.forEach((f,h)=>{u[h]=f}),u}}),Object.defineProperty(this,"sql",{enumerable:!0,configurable:!0,writable:!0,value:async(i,...n)=>{const u=Y(i,n),{rows:f,columns:h}=await this.exec(u.sql,u.params,"all");return K(f,h)}}),Object.defineProperty(this,"batch",{enumerable:!0,configurable:!0,writable:!0,value:async i=>{const n=i(D);return(await this.execBatch(n)).map(({rows:f,columns:h})=>K(f,h))}}),Object.defineProperty(this,"beginTransaction",{enumerable:!0,configurable:!0,writable:!0,value:async()=>{const i=T();await this.createQuery({type:"transaction",transactionKey:i,action:"begin"});const n=async b=>{const p=H(b);if(p.exec)return this.transactionQueryKeyQueue.push(i),p.exec();const{rows:w,columns:q}=await this.exec(p.sql,p.params,"all",i);return K(w,q)};return{query:n,sql:async(b,...p)=>{const w=Y(b,p);return await n(w)},commit:async()=>{await this.createQuery({type:"transaction",transactionKey:i,action:"commit"})},rollback:async()=>{await this.createQuery({type:"transaction",transactionKey:i,action:"rollback"})}}}}),Object.defineProperty(this,"transaction",{enumerable:!0,configurable:!0,writable:!0,value:async i=>x("exclusive",!1,this.config,async()=>{let n;this.bypassMutationLock=!0;try{n=await this.beginTransaction();const u=await i({sql:n.sql,query:n.query});return await n.commit(),u}catch(u){throw await n?.rollback(),u}finally{this.bypassMutationLock=!1}})}),Object.defineProperty(this,"reactiveQuery",{enumerable:!0,configurable:!0,writable:!0,value:i=>{let n=[],u=!1,f=!1,h=0;const b=H(i),p=new Set,w=new Set,q=new Set,E=async()=>{try{const g=++h;if(p.size===0){const y=await this.sql("SELECT name, wr FROM tables_used(?) WHERE type = 'table'",b.sql),k=new Set,P=new Set;if(y.forEach(m=>{typeof m.name=="string"&&(m.wr?P.add(m.name):k.add(m.name))}),k.size===0)throw new Error("The passed SQL does not read any tables.");if(Array.from(P).some(m=>k.has(m)))throw new Error("The passed SQL would mutate one or more of the tables that it reads. Doing this in a reactive query would create an infinite loop.");k.forEach(m=>p.add(m))}const v=b.exec?await b.exec():await this.sql(b.sql,...b.params);g===h&&(n=v,u=!0,w.forEach(y=>y(n)))}catch(g){q.forEach(v=>{v(g instanceof Error?g:new Error(String(g)))})}},M=g=>{g.data.tables.some(v=>p.has(v))&&E()};return{get value(){return n},subscribe:(g,v)=>{if(!this.effectsChannel)throw new Error('This SQLocal instance is not configured for reactive queries. Set the "reactive" option to enable them.');return v||(v=y=>{throw y}),w.add(g),q.add(v),f?u&&g(n):(this.effectsChannel.addEventListener("message",M),f=!0,E()),{unsubscribe:()=>{w.delete(g),q.delete(v),w.size===0&&(this.effectsChannel?.removeEventListener("message",M),f=!1)}}}}}}),Object.defineProperty(this,"createCallbackFunction",{enumerable:!0,configurable:!0,writable:!0,value:async(i,n)=>{await this.createQuery({type:"function",functionName:i,functionType:"callback"}),this.userCallbacks.set(i,n)}}),Object.defineProperty(this,"createScalarFunction",{enumerable:!0,configurable:!0,writable:!0,value:async(i,n)=>{const u=`_sqlocal_func_${i}`,f=()=>{this.proxy[u]=n};this.proxy===globalThis&&f(),await this.createQuery({type:"function",functionName:i,functionType:"scalar"}),this.proxy!==globalThis&&f()}}),Object.defineProperty(this,"createAggregateFunction",{enumerable:!0,configurable:!0,writable:!0,value:async(i,n)=>{const u=`_sqlocal_func_${i}`,f=()=>{this.proxy[`${u}_step`]=n.step,this.proxy[`${u}_final`]=n.final};this.proxy===globalThis&&f(),await this.createQuery({type:"function",functionName:i,functionType:"aggregate"}),this.proxy!==globalThis&&f()}}),Object.defineProperty(this,"getDatabaseInfo",{enumerable:!0,configurable:!0,writable:!0,value:async()=>{const i=await this.createQuery({type:"getinfo"});if(i.type==="info")return i.info;throw new Error("The database failed to return valid information.")}}),Object.defineProperty(this,"getDatabaseFile",{enumerable:!0,configurable:!0,writable:!0,value:async()=>{const i=await this.createQuery({type:"export"});if(i.type==="buffer")return new File([i.buffer],i.bufferName,{type:"application/x-sqlite3"});throw new Error("The database failed to export.")}}),Object.defineProperty(this,"overwriteDatabaseFile",{enumerable:!0,configurable:!0,writable:!0,value:async(i,n)=>{await x("exclusive",!1,this.config,async()=>{try{this.broadcast({type:"close",clientKey:this.clientKey});const u=await ee(i,"buffer");await this.createQuery({type:"import",database:u}),typeof n=="function"&&(this.bypassMutationLock=!0,await n()),this.broadcast({type:"reinit",clientKey:this.clientKey,reason:"overwrite"})}finally{this.bypassMutationLock=!1}})}}),Object.defineProperty(this,"deleteDatabaseFile",{enumerable:!0,configurable:!0,writable:!0,value:async i=>{await x("exclusive",!1,this.config,async()=>{try{this.broadcast({type:"close",clientKey:this.clientKey}),await this.createQuery({type:"delete"}),typeof i=="function"&&(this.bypassMutationLock=!0,await i()),this.broadcast({type:"reinit",clientKey:this.clientKey,reason:"delete"})}finally{this.bypassMutationLock=!1}})}}),Object.defineProperty(this,"destroy",{enumerable:!0,configurable:!0,writable:!0,value:async()=>{await this.createQuery({type:"destroy"}),typeof globalThis.Worker<"u"&&this.processor instanceof Worker&&(this.processor.removeEventListener("message",this.processMessageEvent),this.processor.terminate()),this.queriesInProgress.clear(),this.userCallbacks.clear(),this.reinitChannel.close(),this.effectsChannel?.close(),this.isDestroyed=!0}}),Object.defineProperty(this,re,{enumerable:!0,configurable:!0,writable:!0,value:()=>{this.destroy()}}),Object.defineProperty(this,ie,{enumerable:!0,configurable:!0,writable:!0,value:async()=>{await this.destroy()}});const r=typeof e=="string"?{databasePath:e}:e,{onInit:l,onConnect:t,processor:o,...s}=r,{databasePath:c}=s;this.config=r,this.clientKey=T();const d=te(c,this.clientKey);if(this.reinitChannel=new BroadcastChannel(`_sqlocal_reinit_(${d})`),s.reactive&&(this.effectsChannel=new BroadcastChannel(`_sqlocal_effects_(${d})`)),typeof o<"u")this.processor=o;else if(c==="local"||c===":localStorage:"){const i=new G("local");this.processor=new _(i)}else if(c==="session"||c===":sessionStorage:"){const i=new G("session");this.processor=new _(i)}else if(typeof globalThis.Worker<"u"&&c!==":memory:")this.processor=new Worker(new URL(""+new URL("../workers/worker-YPFv-_J-.js",import.meta.url).href,import.meta.url),{type:"module"});else{const i=new L;this.processor=new _(i)}this.processor instanceof _?(this.processor.onmessage=i=>this.processMessageEvent(i),this.proxy=globalThis):(this.processor.addEventListener("message",this.processMessageEvent),this.proxy=F(this.processor)),this.processor.postMessage({type:"config",config:{...s,clientKey:this.clientKey,onInitStatements:l?.(D)??[]}})}}re=Symbol.dispose,ie=Symbol.asyncDispose;const pe=new ye("database.sqlite3");export{J as _,pe as d};
